<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>STAJ2 - Admin Panel</title>
    <link rel="stylesheet" href="/assets/css/app.css" />
    <style>
        .app-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .management-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }
        /* Modal Stilleri */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: #0f172a !important;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 1.25rem;
            padding: 2rem;
            width: 95%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            color: #f8fafc !important;
        }

        .disk-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 41, 59, 0.7) !important;
            padding: 0.8rem;
            border-radius: 0.75rem;
            margin-bottom: 0.6rem;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #9ca3af;
            }

        .small-select {
            background: #1e293b;
            color: white;
            border: 1px solid #334155;
            padding: 4px;
            border-radius: 4px;
        }

        .role-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: rgba(30, 41, 59, 0.5);
            padding: 8px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <div class="header-row">
                <div>
                    <h1>Staj Monitoring Sistemi</h1>
                    <div class="subtitle">Admin Paneli</div>
                </div>
                <div class="actions">
                    <button class="btn ghost small" id="btnLogout">Çıkış</button>
                </div>
            </div>
        </header>

        <main class="app-main">
            <section class="card">
                <div class="card-header">
                    <h2>Cihaz Yönetimi & Eşik Ayarları</h2>
                    <span class="pill" id="agentCount">0</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>MAC Adresi</th>
                            <th>Orijinal Ad</th>
                            <th>Görünen Ad</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="agentBody"></tbody>
                </table>
            </section>

            <div class="management-grid">
                <section class="card">
                    <div class="card-header">
                        <h2>Bekleyen Kayıt Talepleri</h2>
                        <span class="pill" id="pendingCount">0</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Kullanıcı</th>
                                <th>Rol Ata</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="reqBody"></tbody>
                    </table>
                </section>

                <section class="card">
                    <div class="card-header">
                        <h2>Etiket Yönetimi</h2>
                    </div>
                    <div class="form-group" style="display:flex; gap:10px;">
                        <input type="text" id="newTagName" placeholder="Yeni etiket adı..." class="form-control" style="flex:1">
                        <button onclick="createTag()" class="btn primary small">Ekle</button>
                    </div>
                    <div id="tagList" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:8px;"></div>
                </section>

                <section class="card muted" style="grid-column: span 2;">
                    <div class="card-header">
                        <h2>Sistemdeki Kullanıcılar & Rol Yönetimi</h2>
                        <span class="pill" id="userCount">0</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Kullanıcı</th>
                                <th>Roller (Birden Fazla Seçilebilir)</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="userBody"></tbody>
                    </table>
                </section>
            </div>
        </main>
    </div>

    <div id="thresholdModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #38bdf8; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 10px;">⚙️ Cihaz Ayarları</h3>
            <input type="hidden" id="modalComputerId">

            <div class="form-group">
                <label>CPU Eşik Değeri (%)</label>
                <input type="number" id="cpuThresholdInput" class="form-control" min="0" max="100">
            </div>

            <div class="form-group">
                <label>RAM Eşik Değeri (%)</label>
                <input type="number" id="ramThresholdInput" class="form-control" min="0" max="100">
            </div>

            <div class="form-group">
                <label>Cihaz Etiketleri</label>
                <div id="computerTagsContainer" style="display:flex; flex-wrap:wrap; gap:8px; background:#1e293b; padding:10px; border-radius:8px;"></div>
            </div>

            <div id="diskThresholdsContainer"></div>

            <div class="modal-buttons" style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveThresholds()" class="btn primary" style="flex: 1;">💾 Kaydet</button>
                <button onclick="closeModal()" class="btn ghost" style="flex: 1;">İptal</button>
            </div>
        </div>
    </div>

    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/guards.js"></script>

    <script>
        (function () {
            if (!guards.requireRole(["Yönetici"])) return;

            const endpoints = {
                requests: "/api/Admin/requests",
                approve: (id) => `/api/Admin/approve/${id}`,
                users: "/api/Admin/users",
                changeRoles: (id) => `/api/Admin/users/${id}/change-roles`,
                deleteUser: (id) => `/api/Admin/users/${id}`,
                agents: "/api/agent-telemetry/latest",
                updateName: "/api/Admin/update-display-name",
                getDisks: (id) => `/api/Admin/computers/${id}/disks`,
                updateThresholds: (id) => `/api/Admin/update-thresholds/${id}`,
                tags: "/api/Admin/tags",
                updateComputerTags: (id) => `/api/Admin/computers/${id}/tags`,
                getComputer: (id) => `/api/Admin/computers/${id}`
            };

            const roles = [{ id: 1, name: "Yönetici" }, { id: 2, name: "Denetleyici" }, { id: 3, name: "Görüntüleyici" }];
            const agentBody = document.getElementById("agentBody");
            const userBody = document.getElementById("userBody");
            const reqBody = document.getElementById("reqBody");

            document.getElementById("btnLogout").addEventListener("click", () => {
                auth.clearAuth();
                window.location.href = "/login.html";
            });

            // --- 1. CİHAZ LİSTESİ ---
            async function loadAgents() {
                agentBody.innerHTML = "";
                try {
                    const list = await api.get(endpoints.agents);
                    document.getElementById("agentCount").textContent = list.length;
                    list.forEach(a => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                                <td>${a.macAddress}</td>
                                <td><small class="muted-text">${a.machineName}</small></td>
                                <td><strong>${a.displayName || "-"}</strong></td>
                                <td>
                                    <div class="actions">
                                        <button class="btn small primary" onclick="handleRename(${a.computerId}, '${a.displayName || a.machineName}')">✏️</button>
                                        <button class="btn small warning" onclick="openThresholdSettings(${a.computerId || 0})">⚙️</button>
                                    </div>
                                </td>`;
                        agentBody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            window.handleRename = async (id, currentName) => {
                const newName = prompt(`"${currentName}" için yeni takma ad:`, currentName);
                if (newName) {
                    await api.put(endpoints.updateName, { id: id, newDisplayName: newName.trim() });
                    loadAgents();
                }
            };

            // --- 2. MODAL & EŞİK KONTROLÜ ---
            window.openThresholdSettings = async function (computerId) {
                document.getElementById('modalComputerId').value = computerId;
                try {
                    const [disks, allTags, computer] = await Promise.all([
                        api.get(endpoints.getDisks(computerId)),
                        api.get(endpoints.tags),
                        api.get(endpoints.getComputer(computerId))
                    ]);

                    document.getElementById('cpuThresholdInput').value = computer.cpuThreshold;
                    document.getElementById('ramThresholdInput').value = computer.ramThreshold;

                    const dContainer = document.getElementById('diskThresholdsContainer');
                    dContainer.innerHTML = '<h4 style="margin:15px 0 10px">Disk Sınırları</h4>';
                    disks.forEach(d => {
                        dContainer.innerHTML += `
                                <div class="disk-row">
                                    <span>${d.diskName} (${d.totalSizeGb.toFixed(1)} GB)</span>
                                    <input type="number" class="disk-threshold-input small-select" style="width:60px"
                                           data-name="${d.diskName}" value="${d.thresholdPercent}" min="0" max="100">
                                </div>`;
                    });

                    const tContainer = document.getElementById('computerTagsContainer');
                    tContainer.innerHTML = allTags.map(t => {
                        const isChecked = computer.tags && computer.tags.includes(t.name);
                        return `<label style="font-size:0.8rem; display:flex; align-items:center; gap:5px; cursor:pointer">
                                    <input type="checkbox" class="tag-checkbox" value="${t.name}" ${isChecked ? 'checked' : ''}> ${t.name}</label>`;
                    }).join("");

                    document.getElementById('thresholdModal').style.display = 'flex';
                } catch (e) { alert("Veriler yüklenemedi: " + e.message); }
            };

            window.saveThresholds = async function () {
                const id = document.getElementById('modalComputerId').value;
                const cpuVal = parseFloat(document.getElementById('cpuThresholdInput').value);
                const ramVal = parseFloat(document.getElementById('ramThresholdInput').value);

                // 0-100 Kontrolü
                if ((cpuVal < 0 || cpuVal > 100) || (ramVal < 0 || ramVal > 100)) {
                    alert("Eşik değerleri 0 ile 100 arasında olmalıdır!");
                    return;
                }

                const diskInputs = Array.from(document.querySelectorAll('.disk-threshold-input'));
                for (let input of diskInputs) {
                    const val = parseFloat(input.value);
                    if (val < 0 || val > 100) {
                        alert("Disk eşik değerleri 0-100 arası olmalıdır!");
                        return;
                    }
                }

                const body = {
                    cpuThreshold: isNaN(cpuVal) ? null : cpuVal,
                    ramThreshold: isNaN(ramVal) ? null : ramVal,
                    diskThresholds: diskInputs.map(i => ({
                        diskName: i.dataset.name,
                        thresholdPercent: i.value === "" ? null : parseFloat(i.value)
                    }))
                };

                const selectedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);

                try {
                    await Promise.all([
                        api.put(endpoints.updateThresholds(id), body),
                        api.put(endpoints.updateComputerTags(id), { tags: selectedTags })
                    ]);
                    alert("Başarıyla kaydedildi.");
                    closeModal();
                    loadAgents();
                } catch (e) { alert("Hata: " + e.message); }
            };

            window.closeModal = () => document.getElementById('thresholdModal').style.display = 'none';

            // --- 3. ETİKET YÖNETİMİ ---
            window.createTag = async () => {
                const nameInput = document.getElementById("newTagName");
                const name = nameInput.value.trim();
                if (!name) return;
                try {
                    await api.post(endpoints.tags, { name: name });
                    nameInput.value = "";
                    loadTags();
                } catch (e) { alert("Hata: " + e.message); }
            };

            window.deleteTag = async (id) => {
                if (confirm("Silinsin mi?")) {
                    await api.del(`${endpoints.tags}/${id}`);
                    loadTags();
                }
            };

            async function loadTags() {
                const tags = await api.get(endpoints.tags);
                document.getElementById("tagList").innerHTML = tags.map(t =>
                    `<span class="pill">${t.name} <small onclick="deleteTag(${t.id})" style="cursor:pointer; margin-left:5px; color:#f87171;">×</small></span>`
                ).join("");
            }

            // --- 4. KULLANICI & ÇOKLU ROL YÖNETİMİ ---
            async function loadUsers() {
                userBody.innerHTML = "";
                const list = await api.get(endpoints.users);
                document.getElementById("userCount").textContent = list.length;
                list.forEach(u => {
                    const tr = document.createElement("tr");
                    const roleCheckboxes = roles.map(r => `
                            <label style="display:inline-flex; align-items:center; margin-right:10px; font-size:0.8rem; cursor:pointer;">
                                <input type="checkbox" name="role_${u.id}" value="${r.id}" ${u.roles.includes(r.name) ? 'checked' : ''}>
                                <span style="margin-left:4px">${r.name}</span>
                            </label>`).join("");

                    tr.innerHTML = `
                            <td>${u.username}</td>
                            <td><div class="role-container">${roleCheckboxes}</div></td>
                            <td>
                                <div class="actions">
                                    <button class="btn small primary" onclick="updateUserRoles(${u.id})">💾</button>
                                    ${!u.roles.includes("Yönetici") ? `<button class="btn small danger" onclick="deleteUser(${u.id})">🗑️</button>` : ""}
                                </div>
                            </td>`;
                    userBody.appendChild(tr);
                });
            }

            window.updateUserRoles = async (userId) => {
                const checked = Array.from(document.querySelectorAll(`input[name="role_${userId}"]:checked`));
                const ids = checked.map(cb => parseInt(cb.value));
                if (ids.length === 0) return alert("En az bir rol seçilmeli.");
                try {
                    await api.put(endpoints.changeRoles(userId), { newRoleIds: ids });
                    alert("Güncellendi.");
                    loadUsers();
                } catch (e) { alert("Hata: " + e.message); }
            };

            window.deleteUser = async (id) => {
                if (confirm("Kullanıcıyı silmek istediğinize emin misiniz?")) {
                    await api.del(endpoints.deleteUser(id));
                    loadUsers();
                }
            };

            // --- 5. TALEPLER ---
            async function loadRequests() {
                reqBody.innerHTML = "";
                const list = await api.get(endpoints.requests);
                document.getElementById("pendingCount").textContent = list.length;
                list.forEach(r => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                            <td>${r.username}</td>
                            <td><select class="small-select" data-role>${roles.map(x => `<option value="${x.id}" ${x.id === 3 ? "selected" : ""}>${x.name}</option>`).join("")}</select></td>
                            <td><button class="btn small primary" onclick="approveReq(${r.id}, this)">Onayla</button></td>`;
                    reqBody.appendChild(tr);
                });
            }

            window.approveReq = async (id, btn) => {
                const roleId = btn.closest('tr').querySelector('[data-role]').value;
                await api.post(`/api/Admin/approve/${id}`, { roleId: parseInt(roleId) });
                loadRequests(); loadUsers();
            };

            // Başlat
            loadRequests(); loadUsers(); loadAgents(); loadTags();
        })();
    </script>
</body>
</html>